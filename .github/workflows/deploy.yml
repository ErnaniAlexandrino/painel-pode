name: Deploy Docker Stack to Hostinger

on:
  push:
    branches:
      - main  # Define que a a√ß√£o s√≥ roda em pushes para a branch 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest  # O executor que roda a a√ß√£o

    steps:
      - name: ‚¨áÔ∏è Checkout do C√≥digo
        uses: actions/checkout@v4
        
      - name: ‚öôÔ∏è Configura√ß√£o dos Arquivos de Ambiente (Opcional, mas Recomendado)
        # Se voc√™ tiver arquivos .env, voc√™ pode cri√°-los no servidor usando os segredos do GitHub.
        # Caso contr√°rio, o docker-compose tentar√° buscar as vari√°veis do ambiente.
        run: |
          echo "Criando arquivos .env ou configurando vari√°veis de ambiente no servidor..."

      - name: üñ•Ô∏è Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOSTINGER_HOST }}             # IP ou Dom√≠nio do Servidor
          username: ${{ secrets.HOSTINGER_USERNAME }}     # Seu nome de usu√°rio SSH (pode ser o usu√°rio FTP/cPanel)
          key: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}   # Chave SSH privada para autentica√ß√£o
          port: ${{ secrets.HOSTINGER_PORT}}              # Porta SSH
          script: |
            # 1. Navega para o diret√≥rio de deploy no servidor
            cd /var/www/pwa-app
            
            # 2. Atualiza o c√≥digo do reposit√≥rio (Assumindo que o c√≥digo j√° foi clonado uma vez)
            git pull origin main
            
            # 3. Faz o deploy da stack Docker Compose
            # -d: roda em modo detached (segundo plano)
            # --build: reconstr√≥i as imagens locais (essencial para frontend/backend)
            docker-compose -f docker-compose.yml up -d --build --pull --force-recreate
            
            # 4. Limpeza (opcional, remove imagens n√£o utilizadas)
            docker image prune -f
            
        env:
          # Vari√°veis de ambiente que seu docker-compose.yml precisa (ex: para o MySQL)
          # Isso √© apenas um exemplo, voc√™ deve mapear todas as vari√°veis importantes.
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          # Exemplo para o frontend, se ele precisar:
          CHOKIDAR_USEPOLLING: 'true'
          # Outras vari√°veis...
